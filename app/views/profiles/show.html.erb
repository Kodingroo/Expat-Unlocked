<div class="primary-wrapper is-paddingless has-color">
    <div class="profile">

      <div class="sticky-top profile__left">

        <div class="user-card">
          <div class="user-card__header">
            <% unless current_user.photo.url.nil? %>
            <%= cl_image_tag current_user.photo, class: "avatar" %>
            <% else %>
            <%= image_tag 'avatar.png', class: "avatar" %>
            <% end %>
          </div>
          <div class="user-card__body center-content">
            <%= link_to 'Edit profile',
            edit_user_registration_path(current_user), class: "user-card__edit
            tag" %>
            <div class="user-card__heading">
              <%= current_user.first_name %> <%= current_user.last_name %>
            </div>
            <div class="user-card__info">
              <div class="user-card__title">
                Total bills uploaded
              </div>
              <div class="user-card__count">
                <%= current_user.user_documents.count %>
              </div>
            </div>
          </div>
          <%= simple_form_for(@user_document) do |f| %>
            <%= f.input :photo, required: true, label: 'Bill upload/snap', required: false, input_html: { class: "upload-document", onchange: "loader()" }%>
            <%= f.input :photo_cache, as: :hidden %>
          <% end %>

          <div class="profile-stats">
            <h2>Financial Data for <%= Time.current.year %> </h2>
            <div class="profile-stats__heading">
                <h5>All Bills</h5>
                <p class="profile-stats__display">+</p>
            </div>
            <div class="profile-stats__data">
              <div class="profile-stats__highest">
                <h5>Highest</h5>
                <p><%= number_with_delimiter(@general_stats[:max]) %>¥</p>
              </div>
              <div class="profile-stats__lowest">
                <h5>Lowest</h5>
                <p><%= number_with_delimiter(@general_stats[:min]) %>¥</p>
              </div>
              <div class="profile-stats__average">
                <h5>Average</h5>
                <p><%= number_with_delimiter(@general_stats[:average]) %>¥</p>
              </div>
            </div>
            <div class="profile-stats__heading">
                <h5>Gas Bills</h5>
                <p class="profile-stats__display">+</p>
            </div>
            <div class="profile-stats__data">
              <div class="profile-stats__highest">
                <h5>Highest</h5>
                <p><%= number_with_delimiter(@gas_stats[:max]) %>¥</p>
              </div>
              <div class="profile-stats__lowest">
                <h5>Lowest</h5>
                <p><%= number_with_delimiter(@gas_stats[:min]) %>¥</p>
              </div>
              <div class="profile-stats__average">
                <h5>Average</h5>
                <p><%= number_with_delimiter(@gas_stats[:average]) %>¥</p>
              </div>
            </div>
            <div class="profile-stats__heading">
                <h5>Water Bills</h5>
                <p class="profile-stats__display">+</p>
            </div>
            <div class="profile-stats__data">
               <div class="profile-stats__highest">
                <h5>Highest</h5>
                <p><%= number_with_delimiter(@water_stats[:max]) %>¥</p>
              </div>
              <div class="profile-stats__lowest">
                <h5>Lowest</h5>
                <p><%= number_with_delimiter(@water_stats[:min]) %>¥</p>
              </div>
              <div class="profile-stats__average">
                <h5>Average</h5>
                <p><%= number_with_delimiter(@water_stats[:average]) %>¥</p>
              </div>
            </div>
            <div class="profile-stats__heading">
                <h5>Electricity Bills</h5>
                <p class="profile-stats__display">+</p>
            </div>
            <div class="profile-stats__data">
              <div class="profile-stats__highest">
                <h5>Highest</h5>
                <p><%= number_with_delimiter(@electricity_stats[:max]) %>¥</p>
              </div>
              <div class="profile-stats__lowest">
                <h5>Lowest</h5>
                <p><%= number_with_delimiter(@electricity_stats[:min]) %>¥</p>
              </div>
              <div class="profile-stats__average">
                <h5>Average</h5>
                <p><%= number_with_delimiter(@electricity_stats[:average]) %>¥</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="has-background-primary profile__right">

        <div class="upcoming-card">
          <div class="upcoming-card__heading">
            <h2> Your upcoming bills</h2>
          </div>
          <div class="upcoming-card__body">
              <% sorted = current_user.user_documents.order('due_date ASC').first(3) %>
              <% sorted.each do |user_document| %>
                <% if user_document.created_at.year == Date.today.year &&   user_document.state == false  %>
                <%= render "due-bills", user_document: user_document %>
                <% end %>
              <% end %>

          </div>
        </div>

        <div class="has-background-primary profile__bills">
            <div class="filter">
              <%= form_tag profile_path, method: :get, class: "filter__form" do |f| %>
                <%= select_tag "sort_by", options_for_select(@sort_by, params[:sort_by]), id: "sort-by-select" %>
                <%= select_tag "category", options_for_select(@categories, params[:category]), id: "category-select" %>
              <% end %>

              <div class="bills-list">
                <div class="bills-list__header">
                 <div class="bills-list__company">
                    Bill Type
                  </div>
                  <div class="bills-list__due-date">
                    Due date
                  </div>
                  <div class="bills-list__due">
                    Amount Due
                  </div>
                  <div class="bills-list__paid">
                    State
                  </div>
                </div>

                <% @user_documents.each do |user_document| %>
                  <% if @collection_type == 'due date' %>
                    <%= render "bill-list", user_document: user_document %>
                  <% elsif @collection_type == 'most expensive' %>
                    <%= render "bill-list", user_document: user_document %>
                  <% elsif @collection_type == 'least expensive' %>
                    <%= render "bill-list", user_document: user_document %>
                  <% else %>
                    <%= render "bill-list", user_document: user_document %>
                  <% end %>

                <% end %>
              </div>
            </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const sort_by_change = document.querySelector('#sort-by-select');
  const category_change = document.querySelector('#category-select');

  sort_by_change.addEventListener('change', event => {
    document.querySelector('.filter__form').submit();
  });
  category_change.addEventListener('change', event => {
    document.querySelector('.filter__form').submit();
  });
</script>
